<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<th:block th:replace="fragments/commonHeader"></th:block>
</head>
<body>
<div>
	<header id="header" class="header navbar">
		<div class="header-container max-width-lg mx-auto">
			<ul class="nav-left mrg-left-0 padding-15">
				<li>
					<a href="/">
						<img class="logo desktop-view mrg-top-5" src="/images/logo/zzazanstagram.png">
					</a>
				</li>
				<li class="search-box mrg-left-20 desktop-view">
					<a class="search-toggle no-pdd-right" href="">
						<i class="search-icon ti-search pdd-right-10 font-size-25"></i>
						<i class="search-icon-close ti-close pdd-right-10 font-size-25"></i>
					</a>
				</li>
				<li class="search-input desktop-view">
					<input class="form-control mrg-top-0" type="text" placeholder="Search...">
					<div class="advanced-search">
						<div class="search-wrapper">
							<div class="pdd-vertical-10">
								<ul class="list-unstyled list-info">
									<li class="search-result-item">
										<a href="" class="text-dark">#우테코 1기</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</li>
			</ul>
			<ul class="nav-right padding-15">
				
				<li class="">
					<a class="pointer" href="/articles/new">
						<i class="ti-pencil-alt"></i>
					</a>
				</li>
				<li>
					<a class="pointer">
						<i class="ti-heart"></i>
					</a>
				</li>
				<li>
					<a class="pointer" th:href="@{/members/{nickName}(nickName=${session.member.nickName})}">
						<i class="ti-user"></i>
					</a>
				</li>
			</ul>
		</div>
	</header>
	
	<div class="page-container mrg-top-120">
		<div class="main-content">
			<div class="container-fluid max-width-lg mx-auto">
				<div class="row">
					
					<div id="profile" class="col-lg-12 max-width-lg pdd-btm-30 mrg-top-20 mrg-btm-30 border bottom">
						<div id="profile-img" class="inline-block mrg-horizon-70 mrg-vertical-20 mrg-top-0">
							<img class="thumb-img img-circle my-page-profile-img"
							     th:src="${member.profileImage}" alt="">
						</div>
						<div id="profile-block" class="inline-block mrg-horizon-30 mrg-vertical-20 mrg-top-0">
							<div class="mrg-btm-15">
								<span class="text-center text-bold font-size-25" th:text="${member.nickName}"></span>
								
								<a id="profile-block-settings-btn" class="pointer mrg-left-10 display-none"
								   data-toggle="modal" data-target="#modal-settings">
									<i class="ti-settings font-size-18"></i>
								</a>
								<div class="modal fade" id="modal-settings">
									<div class="modal-dialog modal-sm" role="document">
										<div class="modal-content">
											<div class="btn-group btn-group-vertical width-100">
												<button type="button" class="btn btn-default">
													정보 수정
												</button>
												<button id="profile-block-logout-btn" type="button" class="btn btn-default">
													로그 아웃
												</button>
											</div>
										</div>
									</div>
								</div>
								
								<a id="profile-block-follow-btn"
								   class="btn btn-info mrg-left-10 font-size-10 pdd-vertical-5 pdd-horizon-10 display-none">
									팔로우 하기
								</a>
								
								<a id="profile-block-double-follow-btn"
								   class="btn btn-info mrg-left-10 font-size-10 pdd-vertical-5 pdd-horizon-10 display-none">
									맞팔로우 하기
								</a>
								
								<a id="profile-block-unfollow-modal-btn"
								   class="btn btn-default mrg-left-10 font-size-10 pdd-vertical-5 pdd-horizon-10 display-none"
								   data-toggle="modal" data-target="#modal-following-cancel">
									팔로잉
								</a>
								<div class="modal fade" id="modal-following-cancel">
									<div class="modal-dialog modal-sm" role="document">
										<div class="modal-content">
											<div class="text-center margin-10">
												<img class="thumb-img img-circle my-page-profile-img"
												     th:src="${member.profileImage}" alt="">
											</div>
											<div class="margin-10">
												<span th:text="${member.nickName}"></span>
												<span>님의 팔로우를 취소하시겠어요?</span>
											</div>
											<div class="btn-group btn-group-vertical width-100">
												<button id="profile-block-unfollow-btn" type="button"
												        class="btn btn-default text-color-red">
													팔로우 취소
												</button>
											</div>
										</div>
									</div>
								</div>
							
							</div>
							
							<div class="mrg-btm-15 font-size-15">
								<span class="mrg-right-30">
									<span>게시물</span>
									<span class="text-bold"> 16</span>
								</span>
								<span class="mrg-right-30">
									<a id="follower-btn" class="pointer" data-toggle="modal"
									   data-target="#modal-follower">
										<span>팔로워</span>
										<span class="text-bold"> 91</span>
									</a>
									<div class="modal fade" id="modal-follower">
										<div class="modal-dialog modal-sm" role="document">
											<div class="modal-content">
												<div class="modal-header align-self-center">
													<span class="text-bold">팔로워</span>
												</div>
												<ul id="follower-ul" class="list-unstyled list-info">
                                                </ul>
											</div>
										</div>
									</div>
								</span>
								<span>
									<a id="following-btn" class="pointer" data-toggle="modal"
									   data-target="#modal-following">
										<span>팔로잉</span>
										<span class="text-bold"> 104</span>
									</a>
									<div class="modal fade" id="modal-following">
										<div class="modal-dialog modal-sm" role="document">
											<div class="modal-content">
												<div class="modal-header align-self-center">
													<span class="text-bold">팔로잉</span>
												</div>
												<ul id="following-ul" class="list-unstyled list-info">
                                                </ul>
											</div>
										</div>
									</div>
								</span>
							</div>
							
							<div class="mrg-btm-15 font-size-15">
								<div class="mrg-btm-5">
									<span class="text-bold" th:text="${member.name}"></span>
								</div>
								<div class="font-size-13">
									<span>
										우아한테크코스의 계정에 오신 것을 환영합니당<br>
										좋아요 댓글 팔로우 눌러주세용<br>
										선팔하면 맞팔<br>
									</span>
								</div>
							</div>
						</div>
					</div>
					
					<div class="col-lg-4 col-md-4">
						<!-- TODO : modal id에 article.id 넣어주기 -->
						<div class="card">
							
							<a class="pointer" data-toggle="modal" data-target="#modal-article-id1">
								<div class="bg article-bg-img"
								     style="background-image: url('https://media.gettyimages.com/photos/spring-field-picture-id539016480?s=612x612');">
									<div class="card-block pdd-btm-15">
										<div class="mrg-top-240">
											<div class="text-white text-opacity text-right">
											<span>
												<i class="ti-heart pdd-right-5"></i>
												<span> 168</span>
                                            </span>
												<span class="pdd-horizon-10">
												|
											</span>
												<span>
												<i class="ti-comment pdd-right-5"></i>
												<span> 88</span>
                                            </span>
											</div>
										</div>
									</div>
								</div>
							</a>
							
							<div class="modal fade" id="modal-article-id1">
								<div class="modal-dialog" role="document">
									<div class="modal-content">
										<div class="modal-body">
											
											<div class="card widget-feed no-pdd mrg-btm-70">
												<div class="feed-header padding-15">
													<ul class="list-unstyled list-info">
														<li>
															<img class="thumb-img img-circle"
															     src="https://media.gettyimages.com/photos/spring-field-picture-id539016480?s=612x612"
															     alt="">
															<div class="info">
																<a class="title no-pdd-vertical text-bold inline-block font-size-15">
																	nick
																</a>
															</div>
														</li>
														<a class="pointer absolute top-10 right-0"
														   data-toggle="dropdown"
														   aria-expanded="false">
															<span class="btn-icon text-dark">
																<i class="ti-more font-size-16"></i>
                                                            </span>
														</a>
														<ul class="dropdown-menu">
															<li>
																<a class="pointer">
																	<i class="ti-trash pdd-right-10 text-dark"></i>
																	<span class="">게시글 삭제</span>
																</a>
															</li>
														</ul>
													</ul>
												</div>
												<div class="feed-body no-pdd">
													<img class="img-fluid"
													     src="https://media.gettyimages.com/photos/spring-field-picture-id539016480?s=612x612"
													     alt="">
												</div>
												<ul class="feed-action pdd-horizon-15 pdd-top-5">
													<li>
														<a href="">
															<i class="fa fa-heart-o font-size-25"></i>
														</a>
													</li>
													<li>
														<a href="">
															<i class="ti-comment font-size-22"></i>
														</a>
													</li>
													<li>
														<a href="">
															<i class="ti-export font-size-22"></i>
														</a>
													</li>
													<li class="float-right">
														<a href="" class="pdd-right-0">
															<i class="fa fa-bookmark-o font-size-25"></i>
														</a>
													</li>
												</ul>
												<div class="feedback-status-container pdd-horizon-15">
													<img class="mini-profile-img"
													     src="/images/default/eastjun_profile.jpg">
													<p class="no-mrg pdd-left-5 d-inline-block">
														<span class="text-bold">eastjun</span>님 외 <span
															class="text-bold">37</span>명이 좋아합니다.
													</p>
												</div>
												<div class="feed-footer">
													<div class="comment">
														<ul class="list-unstyled list-info pdd-horizon-5">
															<li class="comment-item no-pdd">
																<div class="info pdd-left-15 pdd-vertical-5">
																	<a href=""
																	   class="title no-pdd-vertical text-bold inline-block font-size-15">
																		nickName
																	</a>
																	<!--<span class="font-size-14">안돌 어디갔다 온거였지?</span>-->
																	<p text="asdf"></p>
																	<p>
																		<a href="" class="hashtag">#우테코1기</a>
																		<a href="" class="hashtag">#베스트커플상</a>
																	</p>
																	<time class="font-size-8 text-gray d-block">12시간 전
																	</time>
																</div>
															</li>
														</ul>
														<div class="add-comment relative">
															<textarea rows="1" class="form-control text-dark padding-15"
															          placeholder="댓글 달기..."></textarea>
															<div class="absolute top-5 right-0">
																<button class="btn btn-default no-border text-gray">게시
																</button>
															</div>
														</div>
													</div>
												</div>
											</div>
										
										
										</div>
									</div>
								</div>
							</div>
						
						</div>
					</div>
					
					
					<div class="col-lg-4 col-md-4">
						<a href="">
							<div class="card">
								<div class="bg article-bg-img"
								     style="background-image: url('https://images.pexels.com/photos/248797/pexels-photo-248797.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500');">
									<div class="card-block pdd-btm-15">
										<div class="mrg-top-240">
											<div class="text-white text-opacity text-right">
											<span>
												<i class="ti-heart pdd-right-5"></i>
												<span> 168</span>
                                            </span>
												<span class="pdd-horizon-10">
												|
											</span>
												<span>
												<i class="ti-comment pdd-right-5"></i>
												<span> 88</span>
                                            </span>
											</div>
										</div>
									</div>
								</div>
							</div>
						</a>
					</div>
				
				</div>
			</div>
		</div>
	</div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
<script src="https://unpkg.com/popper.js/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js"
        integrity="sha384-pjaaA8dDz/5BgdFUPX6M/9SUZv4d12SUPF0axWc+VRZkx5xU3daN+lYb49+Ax+Tl"
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script th:inline="javascript">
    const MYPAGE = (function () {
        const profileBlockSettingsBtn = document.querySelector("#profile-block-settings-btn");
        const profileBlockFollowBtn = document.querySelector("#profile-block-follow-btn");
        const profileBlockDoubleFollowBtn = document.querySelector("#profile-block-double-follow-btn");
        const profileBlockUnFollowModalBtn = document.querySelector("#profile-block-unfollow-modal-btn");
        const profileBlockUnFollowBtn = document.querySelector("#profile-block-unfollow-btn");
        const profileBlockLogoutBtn = document.querySelector("#profile-block-logout-btn");

        const MyPageController = function () {

            const myPageService = new MyPageService();

            const toggleSearchInput = function () {
                document.querySelector('.search-toggle').addEventListener('click', myPageService.toggleSearchInput);
            };

            const showSearchedList = function () {
                document.querySelector(".search-input input").addEventListener("keyup", myPageService.showSearchedList);
            };

            const showFollowingMembers = function () {
                document.querySelector("#following-btn").addEventListener("click", myPageService.showFollowingMembers);
            };

            const showFollowerMembers = function () {
                document.querySelector("#follower-btn").addEventListener("click", myPageService.showFollowerMembers);
            };

            const getFollowRelation = function () {
                myPageService.getFollowRelation();
            };

            const followMember = function () {
                profileBlockFollowBtn.addEventListener("click", myPageService.followMember);
            };

            const unfollowMember = function () {
                profileBlockUnFollowBtn.addEventListener("click", myPageService.unfollowMember);
            };

            const doubleFollowMember = function () {
                profileBlockDoubleFollowBtn.addEventListener("click", myPageService.doubleFollowMember);
            };

            const settings = function () {
                profileBlockSettingsBtn.addEventListener("click", myPageService.settings);
            };
            
            const logout = function() {
				profileBlockLogoutBtn.addEventListener("click", myPageService.logout);
			};

            const init = function () {
                toggleSearchInput();
                showSearchedList();
                showFollowingMembers();
                showFollowerMembers();
                getFollowRelation();
                followMember();
                unfollowMember();
                doubleFollowMember();
                settings();
                logout();
            };

            return {
                init: init,
            }
        };

        const MyPageService = function () {
            const followingUlTag = document.querySelector("#following-ul");
            const followerUlTag = document.querySelector("#follower-ul");

            let isFollower = false;
            let isFollowing = false;
	
			function showBtn(btn) {
				btn.classList.remove('display-none');
				btn.classList.add('display-inline-block');
			}
	
			function hideBtn(btn) {
				btn.classList.remove('display-inline-block');
				btn.classList.add('display-none');
			}
	
            const followMemberTemplate = function (json) {
                return `<div class="pdd-vertical-10 pdd-horizon-20 mrg-vertical-5">
							<img class="thumb-img img-circle"
							src="${json.profileImage}"
							alt="">
							<div class="info">
								<span class="title lh-1-5">${json.nickName}</span>
								<span class="sub-title">
									<span>${json.name}</span>
								</span>
							</div>
						</div>`
            };
	
            const toggleSearchInput = function (event) {
                event.preventDefault();
                document.querySelector('.search-box').classList.toggle('active')
                document.querySelector(".search-input").classList.toggle("active")
                document.querySelector(".search-input input").focus()
            };
	
            const showSearchedList = function (event) {
                if (event.target.value.length > 0) {
                    document.querySelector(".advanced-search").classList.add("active")
                } else {
                    document.querySelector(".advanced-search").classList.remove("active")
                }
            };
	
            const showFollowingMembers = function (event) {
                event.preventDefault();
                axios({
                    method: 'get',
                    url: '/follow/following/' + [[${member.id}]]
                }).then(response => {
                    return response.data;
                }).then(members => {
                    followingUlTag.innerHTML = "";
                    members.forEach((member) => {
                        const liNode = document.createElement("LI");
                        liNode.innerHTML = followMemberTemplate(member.memberResponse);
                        followingUlTag.appendChild(liNode);
                    })
                });
            };
	
            const showFollowerMembers = function (event) {
                event.preventDefault();
                axios({
                    method: 'get',
                    url: '/follow/follower/' + [[${member.id}]]
                }).then(response => {
                    return response.data;
                }).then(members => {
                    followerUlTag.innerHTML = "";
                    members.forEach((member) => {
                        const liNode = document.createElement("LI");
                        liNode.innerHTML = followMemberTemplate(member.memberResponse);
                        followerUlTag.appendChild(liNode);
                    });
                });
            };
	
			const getFollowRelation = function () {
                if ([[${session.member.nickName.equals(member.nickName)}]]) {
					showBtn(profileBlockSettingsBtn);
					return;
                }

                axios({
                    method: 'get',
                    url: '/follow/relation/' + [[${member.id}]]
                }).then(response => {
                    return response.data;
                }).then(data => {
                    isFollower = data.follower;
                    isFollowing = data.following;

                    if (isFollowing) {
                    	showBtn(profileBlockUnFollowModalBtn);
                        return;
                    }

                    if (isFollower) {
                    	showBtn(profileBlockDoubleFollowBtn);
                        return;
                    }
	
                    showBtn(profileBlockFollowBtn);
                });
            };
			
            const followMember = function () {
                const followeeId = [[${session.member.id}]];
                const followerId = [[${member.id}]];
                const formData = new FormData();

                formData.append('followeeId', followeeId);
                formData.append('followerId', followerId);

                axios({
                    method: 'post',
                    url: '/follow',
                    data: formData
                }).then(() => {
                	hideBtn(profileBlockFollowBtn);
                	showBtn(profileBlockUnFollowModalBtn);
                });
            };
	
            const unfollowMember = function () {
                const followeeId = [[${session.member.id}]];
                const followerId = [[${member.id}]];
                const formData = new FormData();

                formData.append('followeeId', followeeId);
                formData.append('followerId', followerId);

                axios({
                    method: 'post',
                    url: '/follow',
                    data: formData
                }).then(() => {
					refreshFollowBtn();
                });
            };
			
			const refreshFollowBtn = function () {
				axios({
					method: 'get',
					url: '/follow/relation/' + [[${member.id}]]
				}).then(response => {
					return response.data;
				}).then(data => {
					isFollower = data.follower;
					isFollowing = data.following;
				}).then(() => {
					hideBtn(profileBlockUnFollowModalBtn);
					document.querySelector('#modal-following-cancel').click();
					
					if (isFollower) {
						showBtn(profileBlockDoubleFollowBtn);
						return;
					}
					showBtn(profileBlockFollowBtn);
				});
			};

            const doubleFollowMember = function () {
                const followeeId = [[${session.member.id}]];
                const followerId = [[${member.id}]];
                const formData = new FormData();

                formData.append('followeeId', followeeId);
                formData.append('followerId', followerId);

                axios({
                    method: 'post',
                    url: '/follow',
                    data: formData
                }).then(() => {
                	hideBtn(profileBlockDoubleFollowBtn);
                	showBtn(profileBlockUnFollowModalBtn);
                });
            };

            const settings = function () {
                // TODO setting
            };
            
            const logout = function () {
            	axios({
					method: 'get',
					url: '/logout'
				}).then(data => {
					window.location = '/login';
				});
			};

            return {
                toggleSearchInput: toggleSearchInput,
                showSearchedList: showSearchedList,
                showFollowingMembers: showFollowingMembers,
                showFollowerMembers: showFollowerMembers,
                getFollowRelation: getFollowRelation,
                followMember: followMember,
                unfollowMember: unfollowMember,
                doubleFollowMember: doubleFollowMember,
                settings: settings,
				logout: logout,
            }
        };

        const init = function () {
            const myPageController = new MyPageController();
            myPageController.init();
        };

        return {
            init: init,
        }
    })();

    MYPAGE.init();
</script>
</body>
</html>
