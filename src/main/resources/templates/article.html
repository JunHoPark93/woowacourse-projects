<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<th:block th:replace="fragments/commonHeader"></th:block>
</head>
<body>
<div>
	<header class="header navbar" id="header">
		<div class="header-container max-width-lg mx-auto">
			<ul class="nav-left mrg-left-0 padding-15">
				<li>
					<a href="/">
						<img class="logo desktop-view mrg-top-5" src="/images/logo/zzazanstagram.png">
					</a>
				</li>
				<li class="search-box mrg-left-20 desktop-view">
					<a class="search-toggle no-pdd-right" href="">
						<i class="search-icon ti-search pdd-right-10 font-size-25"></i>
						<i class="search-icon-close ti-close pdd-right-10 font-size-25"></i>
					</a>
				</li>
				<li class="search-input desktop-view">
					<input class="form-control mrg-top-0" placeholder="Search..." type="text">
					<div class="advanced-search">
						<div class="search-wrapper">
							<div class="pdd-vertical-10">
								<ul class="list-unstyled list-info">
								</ul>
							</div>
						</div>
					</div>
				</li>
			</ul>
			<ul class="nav-right padding-15">
				
				<li class="">
					<a class="pointer" href="/articles/new">
						<i class="ti-pencil-alt"></i>
					</a>
				</li>
				<li>
					<a class="pointer">
						<i class="ti-heart"></i>
					</a>
				</li>
				<li>
					<a class="pointer" th:href="@{/members/{nickName}(nickName=${session.member.nickName})}">
						<i class="ti-user"></i>
					</a>
				</li>
			</ul>
		</div>
	</header>
	
	<div class="page-container mrg-top-120">
		<div class="main-content">
			<div class="container-fluid max-width-lg mx-auto">
				<div class="row">
					<div class="col-lg-7 mx-auto" id="index-articles">
						
						<div class="card article-card widget-feed no-pdd mrg-btm-30" th:id="${article.id}">
							<div class="feed-header padding-15">
								<ul class="list-unstyled list-info">
									<li>
										<img alt="" class="thumb-img img-circle" th:src="${article.profileImage}">
										<div class="info">
											<a class="title no-pdd-vertical text-bold inline-block font-size-15"
											   th:href="@{/members/{nickName}(nickName=${article.nickName})}"
											   th:text="${article.nickName}"></a>
										</div>
									</li>
									<a aria-expanded="false" class="pointer absolute top-10 right-0"
									   data-toggle="dropdown">
				                        <span class="btn-icon text-dark">
				                            <i class="ti-more font-size-16"></i>
				                        </span>
									</a>
									<ul class="dropdown-menu">
										<li class="delete-article">
											<a class="pointer">
												<i class="ti-trash pdd-right-10 text-dark"></i>
												<span class="">게시글 삭제</span>
											</a>
										</li>
									</ul>
								</ul>
							</div>
							<div class="feed-body no-pdd">
								<img alt="" class="img-fluid" th:src="${article.image}">
							</div>
							<ul class="feed-action pdd-horizon-15 pdd-top-5">
								<li>
									<a class="ddabong-area" href="">
										<i class="ddabong-heart fa fa-heart activated-heart font-size-25"
										   th:if="${article.ddabongClicked}"></i>
										<i class="ddabong-heart fa fa-heart-o font-size-25"
										   th:unless="${article.ddabongClicked}"></i>
									</a>
								</li>
								<li>
									<a href="">
										<i class="ti-comment font-size-22"></i>
									</a>
								</li>
								<li>
									<a href="">
										<i class="ti-export font-size-22"></i>
									</a>
								</li>
								<li class="float-right">
									<a class="pdd-right-0" href="">
										<i class="fa fa-bookmark-o font-size-25"></i>
									</a>
								</li>
							</ul>
							<div class="feedback-status-container pdd-horizon-15">
								<p class="no-mrg pdd-left-5 d-inline-block">
									<a class="ddabong-members pointer" data-target="#modal-ddabong-members"
									   data-toggle="modal"
									   th:id="'ddabong-members-' + ${article.id}">
										<span class="ddabong-message text-bold"
										      th:text="${article.ddabongCount}"></span>
									</a>
									명이 좋아합니다.
								</p>
							</div>
							<div class="feed-footer">
								<div class="comment">
									<ul class="list-unstyled list-info pdd-horizon-5">
										<li class=" no-pdd">
											<div class="info pdd-left-15 pdd-vertical-5">
												<a class="title no-pdd-vertical text-bold inline-block font-size-15"
												   th:href="@{/members/{nickName}(nickName=${article.nickName})}"
												   th:text="${article.nickName}"></a>
												<p th:id="'article-contents-' + ${article.id}"></p>
												<time class="font-size-8 text-gray d-block"
												      th:id="'article-lastModifiedDate-' + ${article.id}">
												</time>
											</div>
										</li>
									</ul>
									<ul class="comment-list list-unstyled list-info pdd-horizon-5">
										<li th:each="comment : ${article.commentResponses}">
											<p class="inline-block text-bold no-mrg-btm mrg-left-15"
											   th:text="${comment.commenterNickName}">
											</p>
											<p class="inline-block no-mrg-btm mrg-left-5"
											   th:utext="${comment.commentContents}">
											</p>
										</li>
									</ul>
									<p class="mrg-btm-5"></p>
									<div class="add-comment relative" th:id="'article-comment-input-' + ${article.id}">
										<input class="form-control text-dark padding-15" placeholder="댓글 달기..."
										       rows="1"
										       th:id="'comment-input' + ${article.id}">
										<p class="absolute top-2 right-0">
											<button class="btn btn-default no-border text-gray btn-add-comment">게시
											</button>
										</p>
									</div>
								</div>
							</div>
						</div>
						
						<div class="modal fade" id="modal-ddabong-members">
							<div class="modal-dialog modal-sm" role="document">
								<div class="modal-content">
									<div class="modal-header align-self-center">
										<span class="text-bold">좋아요</span>
									</div>
									<ul class="list-unstyled list-info" id="ddabong-ul">
									</ul>
								</div>
							</div>
						</div>
					
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<th:block th:replace="fragments/cdnScript"></th:block>
<script src="/js/search-box.js"></script>
<script src="/js/ArticleCardTemplate.js"></script>
<script src="/js/MemberCardTemplate.js"></script>
<script th:inline="javascript">

    const ARTICLE_PAGE = (function () {
        const Api = function () {
            const request = {
                get(path, params) {
                    return axios.get(`${path}`, {params: params});
                },
                post(path, data) {
                    return axios.post(`${path}`, data);
                },
                put(path, data) {
                    return axios.put(`${path}`, data);
                },
                delete(path) {
                    return axios.delete(`${path}`);
                }
            };

            return {
                request: request
            };
        };

        const ArticlePageController = function () {
            const articleService = new ArticleService();
            const commentService = new CommentService();
            const ddabongService = new DdabongService();

            const addComment = function () {
                document.querySelectorAll('.btn-add-comment')
                    .forEach(el => el.addEventListener('click', commentService.addComment));
            };

            const toggleHeart = function () {
                document.querySelectorAll('.fa-heart-o')
                    .forEach(el => el.addEventListener('click', ddabongService.toggleHeart));

                document.querySelectorAll('.fa-heart')
                    .forEach(el => el.addEventListener('click', ddabongService.toggleHeart));
            };

            const deleteArticle = function () {
                document.querySelectorAll('.delete-article')
                    .forEach(el => el.addEventListener('click', articleService.deleteArticle));
            };

            const fetchDdabongMembers = function () {
                document.querySelectorAll('.ddabong-members')
                    .forEach(el => el.addEventListener('click', ddabongService.fetchDdabongMembers));
            };

            const init = function () {
                addComment();
                toggleHeart();
                deleteArticle();
                fetchDdabongMembers();
            };

            return {
                init: init,
            };
        };

        const ArticleService = function () {
            const request = new Api().request;

            const deleteArticle = function (event) {
                event.preventDefault();
                const message = event.target.closest("div");
                const articleId = message.parentElement.id;

                request
                    .delete(`/articles/${articleId}`)
                    .then(response => {
                        if (response.data === "SUCCESS") {
                            alert("게시글이 삭제되었습니다.");
                            window.location = '/';
                        }
                    }).catch(error => {
                    const errRes = error.response;
                    if (error.response.status === 401) {
                        alert(errRes.data.msg);
                    }
                });
            };

            return {
                deleteArticle: deleteArticle,
            }
        };

        const CommentService = function () {
            const request = new Api().request;
            const articleCardTemplate = new ArticleCardTemplate();

            const addComment = function (event) {
                const message = event.target.closest("div");
                const articleIdSplits = message.id.split("-");
                const articleId = articleIdSplits[articleIdSplits.length - 1];

                const input = message.querySelector("input");
                let inputValue = input.value;
                const commentList = message.parentElement.querySelector(".comment-list");

                if (inputValue.length < 1 || inputValue.length > 500) {
                    alert('댓글은 1글자 이상 500글자 이하로 입력해 주세요');
                    return;
                }

                inputValue = inputValue.replace(/&/gi, "&amp;");
                inputValue = inputValue.replace(/</gi, "&lt;");
                inputValue = inputValue.replace(/>/gi, "&gt;");

                request
                    .post(`/${articleId}/comments/new`, {contents: inputValue})
                    .then(res => {
                        console.log(res);
                        const comment = articleCardTemplate.comment(res.data);
                        commentList.insertAdjacentHTML('beforeend', comment);
                        input.value = '';
                    }).catch(err => {
                    alert(err.response.data.msg);
                });
            };

            return {
                addComment: addComment,
            }
        };

        const DdabongService = function () {
            const memberCardTemplate = new MemberCardTemplate();
            const request = new Api().request;

            function activeDdabong(el) {
                el.classList.remove('fa-heart-o');
                el.classList.add('fa-heart', 'activated-heart');
            }

            function disableDdabong(el) {
                el.classList.remove('fa-heart', 'activated-heart');
                el.classList.add('fa-heart-o');
            }

            const toggleHeart = function (event) {
                event.preventDefault();
                const message = event.target.closest("div");
                let articleId = message.id;

                const splits = articleId.split('-');
                if (splits.length > 1) {
                    articleId = splits[splits.length - 1];
                }
                const ddabongCountTag = message.querySelector('.ddabong-message');

                request
                    .get(`/api/ddabongs/articles/${articleId}`)
                    .then(response => {
                        ddabongCountTag.innerText = response.data.count;

                        if (response.data.clicked) {
                            activeDdabong(event.target);
                        } else {
                            disableDdabong(event.target);
                        }
                    });
            };

            const fetchDdabongMembers = function (event) {
                const message = event.target.closest("div").parentNode;
                const articleIdSplits = message.id.split("-");
                const articleId = articleIdSplits[articleIdSplits.length - 1];

                const ddabongUlTag = document.querySelector('#ddabong-ul');

                request
                    .get(`/api/ddabongs/members/${articleId}`)
                    .then(response => {
                        return response.data.memberResponses;
                    })
                    .then(memberResponses => {
                        ddabongUlTag.innerHTML = "";
                        memberResponses.forEach(member => {
                            const memberNode = document.createElement("LI");
                            memberNode.innerHTML = memberCardTemplate.memberTemplate(member);
                            ddabongUlTag.appendChild(memberNode);
                        })
                    })
            };

            return {
                activeDdabong: activeDdabong,
                toggleHeart: toggleHeart,
                fetchDdabongMembers: fetchDdabongMembers,
            }
        };

        const articlePageController = new ArticlePageController();

        const init = function () {
            articlePageController.init();
        };

        return {
            init: init,
        }
    })();

    ARTICLE_PAGE.init();

    window.onload = function () {
        const article = [[${article}]];

        const articleContents = document.getElementById(`article-contents-${article.id}`);
        const contentsTag = article.contents
            .split(/[ \t\r\n\v\f]/g)
            .map(w => (w.startsWith('#') ? `<a href="/tags/${w.substring(1)}" class="hashtag">${w}</a>` : w))
            .join(' ');

        articleContents.insertAdjacentHTML('afterbegin', contentsTag);

        const lastModifiedDate = document.getElementById(`article-lastModifiedDate-${article.id}`);
        lastModifiedDate.insertAdjacentText('afterbegin', postedTime(article.lastModifiedDate));
    };

    const postedTime = function (date) {
        const currentDate = new Date();
        const postedDate = new Date(date);
        const elapsed = Math.floor((currentDate.getTime() - postedDate.getTime()) / 1000);

        if (elapsed >= 24 * 60 * 60) {
            return `${postedDate.getUTCFullYear()}년${postedDate.getMonth() + 1}월${postedDate.getDate()}일`;
        } else if (elapsed <= 60 * 60) {
            return `${Math.floor(elapsed / 60)}분 전`;
        }

        return `${Math.floor(elapsed / (60 * 60))}시간 전`;
    };

</script>
</body>
</html>